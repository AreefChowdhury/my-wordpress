{"version":3,"names":["v4","createId","__","formatListNumbered","icon","insertObject","RichTextToolbarButton","store","blockEditorStore","privateApis","useSelect","useDispatch","useRegistry","coreDataStore","createBlock","blocksStore","unlock","usesContextKey","formatName","POST_CONTENT_BLOCK_NAME","SYNCED_PATTERN_BLOCK_NAME","format","title","tagName","className","attributes","interactive","contentEditable","edit","Edit","value","onChange","isObjectActive","context","postType","postId","registry","getSelectedBlockClientId","getBlocks","getBlockRootClientId","getBlockName","getBlockParentsByBlockName","select","isFootnotesSupported","getBlockType","entityRecord","getEntityRecord","meta","footnotes","_getBlockParentsByBlockName","_getSelectedBlockClientId","parentCoreBlocks","length","selectionChange","insertBlock","onClick","batch","id","object","replacements","start","newValue","type","innerHTML","end","selectedClientId","parentPostContent","blocks","fnBlock","queue","block","shift","name","push","innerBlocks","rootClientId","undefined","clientId","createElement","isActive"],"sources":["@wordpress/block-library/src/footnotes/format.js"],"sourcesContent":["/**\n * External dependencies\n */\nimport { v4 as createId } from 'uuid';\n\n/**\n * WordPress dependencies\n */\nimport { __ } from '@wordpress/i18n';\nimport { formatListNumbered as icon } from '@wordpress/icons';\nimport { insertObject } from '@wordpress/rich-text';\nimport {\n\tRichTextToolbarButton,\n\tstore as blockEditorStore,\n\tprivateApis,\n} from '@wordpress/block-editor';\nimport { useSelect, useDispatch, useRegistry } from '@wordpress/data';\nimport { store as coreDataStore } from '@wordpress/core-data';\nimport { createBlock, store as blocksStore } from '@wordpress/blocks';\n\n/**\n * Internal dependencies\n */\nimport { unlock } from '../lock-unlock';\n\nconst { usesContextKey } = unlock( privateApis );\n\nexport const formatName = 'core/footnote';\n\nconst POST_CONTENT_BLOCK_NAME = 'core/post-content';\nconst SYNCED_PATTERN_BLOCK_NAME = 'core/block';\n\nexport const format = {\n\ttitle: __( 'Footnote' ),\n\ttagName: 'sup',\n\tclassName: 'fn',\n\tattributes: {\n\t\t'data-fn': 'data-fn',\n\t},\n\tinteractive: true,\n\tcontentEditable: false,\n\t[ usesContextKey ]: [ 'postType', 'postId' ],\n\tedit: function Edit( {\n\t\tvalue,\n\t\tonChange,\n\t\tisObjectActive,\n\t\tcontext: { postType, postId },\n\t} ) {\n\t\tconst registry = useRegistry();\n\t\tconst {\n\t\t\tgetSelectedBlockClientId,\n\t\t\tgetBlocks,\n\t\t\tgetBlockRootClientId,\n\t\t\tgetBlockName,\n\t\t\tgetBlockParentsByBlockName,\n\t\t} = registry.select( blockEditorStore );\n\t\tconst isFootnotesSupported = useSelect(\n\t\t\t( select ) => {\n\t\t\t\tif (\n\t\t\t\t\t! select( blocksStore ).getBlockType( 'core/footnotes' )\n\t\t\t\t) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tconst entityRecord = select( coreDataStore ).getEntityRecord(\n\t\t\t\t\t'postType',\n\t\t\t\t\tpostType,\n\t\t\t\t\tpostId\n\t\t\t\t);\n\n\t\t\t\tif ( 'string' !== typeof entityRecord?.meta?.footnotes ) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\t// Checks if the selected block lives within a pattern.\n\t\t\t\tconst {\n\t\t\t\t\tgetBlockParentsByBlockName: _getBlockParentsByBlockName,\n\t\t\t\t\tgetSelectedBlockClientId: _getSelectedBlockClientId,\n\t\t\t\t} = select( blockEditorStore );\n\t\t\t\tconst parentCoreBlocks = _getBlockParentsByBlockName(\n\t\t\t\t\t_getSelectedBlockClientId(),\n\t\t\t\t\tSYNCED_PATTERN_BLOCK_NAME\n\t\t\t\t);\n\t\t\t\treturn ! parentCoreBlocks || parentCoreBlocks.length === 0;\n\t\t\t},\n\t\t\t[ postType, postId ]\n\t\t);\n\n\t\tconst { selectionChange, insertBlock } =\n\t\t\tuseDispatch( blockEditorStore );\n\n\t\tif ( ! isFootnotesSupported ) {\n\t\t\treturn null;\n\t\t}\n\n\t\tfunction onClick() {\n\t\t\tregistry.batch( () => {\n\t\t\t\tlet id;\n\t\t\t\tif ( isObjectActive ) {\n\t\t\t\t\tconst object = value.replacements[ value.start ];\n\t\t\t\t\tid = object?.attributes?.[ 'data-fn' ];\n\t\t\t\t} else {\n\t\t\t\t\tid = createId();\n\t\t\t\t\tconst newValue = insertObject(\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttype: formatName,\n\t\t\t\t\t\t\tattributes: {\n\t\t\t\t\t\t\t\t'data-fn': id,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tinnerHTML: `<a href=\"#${ id }\" id=\"${ id }-link\">*</a>`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tvalue.end,\n\t\t\t\t\t\tvalue.end\n\t\t\t\t\t);\n\t\t\t\t\tnewValue.start = newValue.end - 1;\n\t\t\t\t\tonChange( newValue );\n\t\t\t\t}\n\n\t\t\t\tconst selectedClientId = getSelectedBlockClientId();\n\n\t\t\t\t/*\n\t\t\t\t * Attempts to find a common parent post content block.\n\t\t\t\t * This allows for locating blocks within a page edited in the site editor.\n\t\t\t\t */\n\t\t\t\tconst parentPostContent = getBlockParentsByBlockName(\n\t\t\t\t\tselectedClientId,\n\t\t\t\t\tPOST_CONTENT_BLOCK_NAME\n\t\t\t\t);\n\n\t\t\t\t// When called with a post content block, getBlocks will return\n\t\t\t\t// the block with controlled inner blocks included.\n\t\t\t\tconst blocks = parentPostContent.length\n\t\t\t\t\t? getBlocks( parentPostContent[ 0 ] )\n\t\t\t\t\t: getBlocks();\n\n\t\t\t\t// BFS search to find the first footnote block.\n\t\t\t\tlet fnBlock = null;\n\t\t\t\t{\n\t\t\t\t\tconst queue = [ ...blocks ];\n\t\t\t\t\twhile ( queue.length ) {\n\t\t\t\t\t\tconst block = queue.shift();\n\t\t\t\t\t\tif ( block.name === 'core/footnotes' ) {\n\t\t\t\t\t\t\tfnBlock = block;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tqueue.push( ...block.innerBlocks );\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Maybe this should all also be moved to the entity provider.\n\t\t\t\t// When there is no footnotes block in the post, create one and\n\t\t\t\t// insert it at the bottom.\n\t\t\t\tif ( ! fnBlock ) {\n\t\t\t\t\tlet rootClientId = getBlockRootClientId( selectedClientId );\n\n\t\t\t\t\twhile (\n\t\t\t\t\t\trootClientId &&\n\t\t\t\t\t\tgetBlockName( rootClientId ) !== POST_CONTENT_BLOCK_NAME\n\t\t\t\t\t) {\n\t\t\t\t\t\trootClientId = getBlockRootClientId( rootClientId );\n\t\t\t\t\t}\n\n\t\t\t\t\tfnBlock = createBlock( 'core/footnotes' );\n\n\t\t\t\t\tinsertBlock( fnBlock, undefined, rootClientId );\n\t\t\t\t}\n\n\t\t\t\tselectionChange( fnBlock.clientId, id, 0, 0 );\n\t\t\t} );\n\t\t}\n\n\t\treturn (\n\t\t\t<RichTextToolbarButton\n\t\t\t\ticon={ icon }\n\t\t\t\ttitle={ __( 'Footnote' ) }\n\t\t\t\tonClick={ onClick }\n\t\t\t\tisActive={ isObjectActive }\n\t\t\t/>\n\t\t);\n\t},\n};\n"],"mappings":"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"}